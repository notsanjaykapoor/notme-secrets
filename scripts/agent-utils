#!/usr/bin/env python

import os
import re
import sys

sys.path.insert(1, os.path.join(sys.path[0], ".."))

import dot_init

import asyncclick as click

import models
import services.agents
import services.console
import services.database.session
import services.places.tools


@click.group()
def cli():
    pass

@click.command()
async def conv_start() -> int:
    """
    Start a new conversation
    """
    services.console.print_status("conversation start: \r\n")

    agent_anth = services.agents.create_agent_anthropic()
    agent_places = services.agents.create_agent_places(
        model=services.agents.model_gemini(),
        output_types=services.places.tools.list_all(),
    )

    msgs_history = []

    while True:
        user_query = input("query: ")

        if re.match(r"^(bye|exit|quit)", user_query):
            services.console.print_status("conversation exiting")
            break

        if re.match(r"^(breakpoint|debug)", user_query):
            services.console.print_status("conversation debugger")
            breakpoint()

        print("")

        if services.places.tools.match_tool_use(query=user_query):
            result = await agent_places.run(user_prompt=user_query)
            places: list[models.Place] = result.output

            services.console.print_fragment(
                services.places.tools.output_markdown(places=places)
            )
            print("")

            print(f"messages turn size {len(result.new_messages())}") # xxx
            print(result.new_messages_json())
            print("")
        else:
            async with agent_anth.run_stream(
                user_prompt=user_query,
                message_history=msgs_history,
            ) as response:
                async for text in response.stream_text(delta=True):
                    if text:
                        services.console.print_fragment(text)

                print("")

                msgs_history.extend(response.new_messages())

                services.console.print_status(f"\r\nconversation history {len(msgs_history)} messages:\r\n")
            
                print(msgs_history) # xxx
                print("")

    return 0

cli.add_command(conv_start)

if __name__ == "__main__":
    cli()
